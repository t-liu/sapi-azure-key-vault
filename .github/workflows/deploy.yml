name: Azure Function CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  PYTHON_VERSION: '3.11'
  AZURE_FUNCTIONAPP_NAME_STAGING: 'sapi-azure-key-vault'
  AZURE_FUNCTIONAPP_NAME_PROD: 'sapi-azure-key-vault-prod'
  AZURE_FUNCTIONAPP_PACKAGE_PATH: '.'

jobs:
  # ============================================================================
  # STAGE 1: Lint & Static Analysis
  # ============================================================================
  lint-and-analysis:
    name: Lint & Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run Black (Code Formatter Check)
        run: |
          black --check --diff .
        continue-on-error: false

      - name: Run Flake8 (Linting)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run Pylint (Code Quality)
        run: |
          pylint app/ --exit-zero

      - name: Run MyPy (Type Checking)
        run: |
          mypy app/ --ignore-missing-imports
        continue-on-error: true

      - name: Run Bandit (Security Analysis)
        run: |
          bandit -r . -f json -o security-analysis-report.json || true
          bandit -r . -ll

      - name: Upload Security Analysis Report (Bandit)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-analysis-report
          path: security-analysis-report.json

  # ============================================================================
  # STAGE 2: Unit Tests
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint-and-analysis
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run Unit Tests with Coverage
        run: |
          pytest tests/unit/ -v --cov=. --cov-report=xml --cov-report=html --cov-report=term-missing
        env:
          AZURE_KEY_VAULT_URL: https://test-vault.vault.azure.net/
          VALID_CLIENT_ID: test-client-id
          VALID_CLIENT_SECRET: test-client-secret

      - name: Upload Coverage Report
        uses: codecov/codecov-action@v3
        if: always()
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: Upload HTML Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: htmlcov/

  # ============================================================================
  # STAGE 3: Build and Package Artifact
  # ============================================================================
  build-and-package:
    name: Build & Package Artifact
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Create artifact directory
        run: |
          mkdir -p artifact
          
          # Create the target directory structure
          mkdir -p artifact/.python_packages/lib/site-packages
          
          # Copy function_app.py to root
          cp function_app.py artifact/
          # cp test_function_app.py artifact/function_app.py
          
          # Copy app module
          mkdir -p artifact/app
          cp app/__init__.py artifact/app/
          cp app/keyvault_service.py artifact/app/
          cp app/models.py artifact/app/
          cp app/rate_limiter.py artifact/app/
          cp app/constants.py artifact/app/
          
          # Copy config
          cp host.json artifact/
          cp requirements.txt artifact/
          
          # Install deps into artifact
          python -m pip install --upgrade pip
          pip install --target="artifact/.python_packages/lib/site-packages" -r requirements.txt

          echo "=== DEPLOYMENT PACKAGE ==="
          find artifact -type f | sort
          echo ""
          echo "=== VERIFY function_app.py at root ==="
          ls -la artifact/function_app.py
          
          echo ""
          echo "=== CHECK imports in function_app.py ==="
          head -30 artifact/function_app.py | grep "^from\|^import"
          
          echo ""
          echo "=== VERIFY app module files ==="
          ls -la artifact/app/

      - name: Upload artifact for deployment
        uses: actions/upload-artifact@v4
        with:
          name: azure-function-app
          path: artifact/
          retention-days: 7

  # ============================================================================
  # STAGE 4: Deploy to Staging
  # ============================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-package
    environment:
      name: staging
      url: https://${{ env.AZURE_FUNCTIONAPP_NAME_STAGING }}.azurewebsites.net
    outputs:
      staging-url: ${{ steps.get-url.outputs.url }}
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: azure-function-app
          path: ./artifact

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_STAGING }}

      - name: Deploy to Azure Function
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME_STAGING }}
          package: ./artifact
          respect-funcignore: true
          enable-oryx-build: false

      - name: Wait for deployment to stabilize
        run: sleep 45

      - name: Get URL
        id: get-url
        run: |
          STAGING_URL=$(az functionapp show \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME_STAGING }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --query "defaultHostName" -o tsv)
          echo "url=https://${STAGING_URL}" >> $GITHUB_OUTPUT
          echo "Staging URL: https://${STAGING_URL}"
      
      - name: Debug - Check deployed file structure via Kudu
        run: |
          echo "=== Getting Kudu credentials ==="
          CREDS=$(az webapp deployment list-publishing-credentials \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME_STAGING }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --query "{username:publishingUserName, password:publishingPassword}" -o json)
          
          USERNAME=$(echo $CREDS | jq -r .username)
          PASSWORD=$(echo $CREDS | jq -r .password)

          echo ""
          echo "=== Checking if app/ modules exist ==="
          curl -s -u "$USERNAME:$PASSWORD" \
            "https://sapi-azure-key-vault-staging.azurewebsites.net/api/vfs/site/wwwroot/app/" \
            | jq -r '.[].name' || echo "app/ directory missing"

          echo "=== Checking wwwroot structure ==="
          curl -u "$USERNAME:$PASSWORD" \
            "sapi-azure-key-vault-staging.azurewebsites.net/api/vfs/site/wwwroot/" \
            | jq '.'
          
          echo "=== Checking if function_app.py exists at root ==="
          curl -u "$USERNAME:$PASSWORD" \
            "sapi-azure-key-vault-staging.azurewebsites.net/api/vfs/site/wwwroot/function_app.py" \
            -I | head -5

      - name: Debug - Check Function Host logs
        run: |
          echo "=== Fetching Function Host logs ==="
          az webapp log download \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME_STAGING }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --log-file logs.zip || true
          
          if [ -f logs.zip ]; then
            unzip -p logs.zip */error* 2>/dev/null || echo "No error logs"
            unzip -p logs.zip */host* 2>/dev/null | tail -50 || echo "No host logs"
          fi
      
      - name: Verify deployed functions (DEBUG)
        run: |
          echo "=== Listing deployed functions ==="
          az functionapp function list \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME_STAGING }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --query "[].{Name:name, Config:config.bindings[0].route, Status:state}" -o table
          
          echo "=== Raw JSON output ==="
          az functionapp function list \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME_STAGING }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --query "[]" -o json
          
          echo "=== Checking function app logs for import errors ==="
          az monitor log-analytics query \
            --workspace ${{ secrets.APP_INSIGHTS_NAME }} \
            --analytics-query "AppExceptions | where Operation_Name == 'FunctionAppLogs' | take 10" \
            -o table || echo "No App Insights logs found"

  # ============================================================================
  # STAGE 5: Integration Tests (Staging)
  # ============================================================================
  integration-tests-staging:
    name: Integration Tests (Staging)
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run Integration Tests
        run: |
          pytest tests/integration/ -v --tb=short
        env:
          API_BASE_URL: ${{ needs.deploy-staging.outputs.staging-url }}/api
          API_CLIENT_ID: ${{ secrets.TEST_API_CLIENT_ID }}
          API_CLIENT_SECRET: ${{ secrets.TEST_API_CLIENT_SECRET }}
          ENVIRONMENT: staging

      - name: Check Function App Logs
        if: always()
        run: |
          echo "Fetching recent logs from Function App..."
          az functionapp log tail \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME_STAGING }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \

      - name: Upload Integration Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: test-results/

  # ============================================================================
  # STAGE 6: Smoke/Canary Tests (Staging)
  # ============================================================================
  smoke-tests-staging:
    name: Smoke Tests (Staging)
    runs-on: ubuntu-latest
    needs: integration-tests-staging
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pytest

      - name: Run Smoke Tests
        run: |
          pytest tests/smoke/ -v --tb=short
        env:
          API_BASE_URL: ${{ needs.deploy-staging.outputs.staging-url }}/api
          API_CLIENT_ID: ${{ secrets.TEST_API_CLIENT_ID }}
          API_CLIENT_SECRET: ${{ secrets.TEST_API_CLIENT_SECRET }}

      - name: Health Check
        run: |
          python tests/smoke/health_check.py
        env:
          API_BASE_URL: ${{ needs.deploy-staging.outputs.staging-url }}/api
          API_CLIENT_ID: ${{ secrets.TEST_API_CLIENT_ID }}
          API_CLIENT_SECRET: ${{ secrets.TEST_API_CLIENT_SECRET }}

  # ============================================================================
  # STAGE 7: Manual Approval Gate (for Production)
  # ============================================================================
  approval-gate:
    name: Production Deployment Approval
    runs-on: ubuntu-latest
    needs: smoke-tests-staging
    environment:
      name: production-approval
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Manual Approval Required
        run: |
          echo "‚úÖ Staging validation complete"
          echo "‚è≥ Awaiting manual approval for production deployment..."
          echo "üìä Review staging metrics before approving"

  # ============================================================================
  # STAGE 9: Post-Deploy Monitoring & Validation
  # ============================================================================
  post-deploy-validation:
    name: Post-Deploy Monitoring & Validation
    runs-on: ubuntu-latest
    needs: deploy-production
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pytest

      - name: Production Smoke Tests
        id: prod-smoke
        run: |
          pytest tests/smoke/ -v --tb=short
        env:
          API_BASE_URL: https://${{ env.AZURE_FUNCTIONAPP_NAME_PROD }}.azurewebsites.net/api
          API_CLIENT_ID: ${{ secrets.PROD_API_CLIENT_ID }}
          API_CLIENT_SECRET: ${{ secrets.PROD_API_CLIENT_SECRET }}
        continue-on-error: true

      - name: Health Check Monitoring
        id: health-check
        run: |
          python tests/smoke/health_check.py --monitor --duration=120
        env:
          API_BASE_URL: https://${{ env.AZURE_FUNCTIONAPP_NAME_PROD }}.azurewebsites.net/api
          API_CLIENT_ID: ${{ secrets.PROD_API_CLIENT_ID }}
          API_CLIENT_SECRET: ${{ secrets.PROD_API_CLIENT_SECRET }}
        continue-on-error: true

      - name: Check Application Insights Metrics
        uses: azure/CLI@v1
        continue-on-error: true
        with:
          inlineScript: |
            # Query Application Insights for error rate
            az monitor app-insights metrics show \
              --app ${{ secrets.APP_INSIGHTS_NAME }} \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --metric requests/failed \
              --interval PT5M

      - name: Send Rollback Notification
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "@type": "MessageCard",
              "@context": "https://schema.org/extensions",
              "summary": "üö® ROLLBACK EXECUTED",
              "themeColor": "FF0000",
              "title": "üö® Production Deployment Rollback",
              "sections": [{
                "activityTitle": "Deployment Failed Validation",
                "activitySubtitle": "Automatic rollback initiated",
                "facts": [
                  { "name": "Environment:", "value": "Production" },
                  { "name": "Function App:", "value": "${{ env.AZURE_FUNCTIONAPP_NAME_PROD }}" },
                  { "name": "Commit:", "value": "${{ github.sha }}" },
                  { "name": "Author:", "value": "${{ github.actor }}" },
                  { "name": "Status:", "value": "Rolled back to previous version" }
                ],
                "text": "Deployment was automatically rolled back due to failed health checks. Please investigate before retrying."
              }],
              "potentialAction": [{
                "@type": "OpenUri",
                "name": "View Workflow Run",
                "targets": [{ "os": "default", "uri": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" }]
              }]
            }' \
            ${{ secrets.TEAMS_WEBHOOK_URL }}

      - name: Create GitHub Issue on Rollback
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Production Deployment Rollback - ' + new Date().toISOString(),
              body: 'Production deployment was automatically rolled back due to failed health checks.\n\nPlease investigate the failure and retry deployment.',
              labels: ['production', 'rollback', 'critical']
            })

      - name: Success Notification
        if: success()
        run: |
          echo "‚úÖ Production deployment successful and validated"
          echo "üìä Monitoring will continue via Application Insights"

  # ============================================================================
  # Notification Job
  # ============================================================================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [post-deploy-validation]
    if: always()
    steps:
      - name: Send Success Notification
        if: needs.post-deploy-validation.result == 'success'
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "@type": "MessageCard",
              "@context": "https://schema.org/extensions",
              "summary": "‚úÖ Production Deployment Successful",
              "themeColor": "00FF00",
              "title": "‚úÖ Production Deployment Complete",
              "sections": [{
                "activityTitle": "Deployment Successful",
                "activitySubtitle": "All health checks passed",
                "facts": [
                  { "name": "Environment:", "value": "Production" },
                  { "name": "Function App:", "value": "${{ env.AZURE_FUNCTIONAPP_NAME_PROD }}" },
                  { "name": "Repository:", "value": "${{ github.repository }}" },
                  { "name": "Commit:", "value": "${{ github.sha }}" },
                  { "name": "Author:", "value": "${{ github.actor }}" },
                  { "name": "Branch:", "value": "${{ github.ref_name }}" }
                ],
                "text": "Production deployment completed successfully. All smoke tests and health checks passed."
              }],
              "potentialAction": [{
                "@type": "OpenUri",
                "name": "View Deployment",
                "targets": [{ "os": "default", "uri": "https://${{ env.AZURE_FUNCTIONAPP_NAME_PROD }}.azurewebsites.net" }]
              }]
            }' \
            ${{ secrets.TEAMS_WEBHOOK_URL }}

      - name: Send Failure Notification
        if: needs.post-deploy-validation.result == 'failure'
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "@type": "MessageCard",
              "@context": "https://schema.org/extensions",
              "summary": "‚ùå Production Deployment Failed",
              "themeColor": "FF0000",
              "title": "‚ùå Production Deployment Failed",
              "sections": [{
                "activityTitle": "Deployment Failed",
                "activitySubtitle": "Automatic rollback completed",
                "facts": [
                  { "name": "Environment:", "value": "Production" },
                  { "name": "Repository:", "value": "${{ github.repository }}" },
                  { "name": "Commit:", "value": "${{ github.sha }}" },
                  { "name": "Author:", "value": "${{ github.actor }}" },
                  { "name": "Branch:", "value": "${{ github.ref_name }}" },
                  { "name": "Status:", "value": "Rolled back to previous version" }
                ],
                "text": "Production deployment failed validation and was automatically rolled back. Please review the logs and investigate the issue."
              }],
              "potentialAction": [{
                "@type": "OpenUri",
                "name": "View Workflow Run",
                "targets": [{ "os": "default", "uri": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" }]
              }]
            }' \
            ${{ secrets.TEAMS_WEBHOOK_URL }}